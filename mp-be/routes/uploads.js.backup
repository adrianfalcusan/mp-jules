const express = require("express");
const path = require("path");
const fs = require("fs");
const router = express.Router();
const BunnyCDNService = require("../services/bunnycdn.service");

// Use a raw body parser only for this route
const rawParser = express.raw({ type: "*/*", limit: "15mb" });

// PUT /api/upload/thumbnail?filename=name.png
router.put("/thumbnail", rawParser, async (req, res) => {
  try {
    const filename = (
      req.query.filename || "thumbnail-" + Date.now() + ".jpg"
    ).toString();
    const tempDir = path.join(__dirname, "..", "temp-uploads");
    if (!fs.existsSync(tempDir)) fs.mkdirSync(tempDir, { recursive: true });
    const tempPath = path.join(tempDir, `${Date.now()}-${filename}`);

    // Save raw body to temp file
    fs.writeFileSync(tempPath, req.body);

    // Upload to Bunny
    const bunny = new BunnyCDNService();
    const upload = await bunny.uploadFile(tempPath, filename, "thumbnails");

    // Cleanup
    fs.unlinkSync(tempPath);

    return res.status(200).json({ success: true, url: upload.url });
  } catch (err) {
    console.error("Direct thumbnail upload error:", err);
    return res
      .status(500)
      .json({ success: false, message: "Direct thumbnail upload failed" });
  }
});

module.exports = router;
